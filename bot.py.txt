import telebot
import random

BOT_TOKEN = "8216185202:AAGb62dCp6El_bnpmwx2fMHEQEgXgsaFZS0"

bot = telebot.TeleBot(BOT_TOKEN)

participants = {}  # {"username": {"name": ..., "wish": ...}}
admin_id = None
game_started = False

@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message, "üéÖ –ü—Ä–∏–≤—ñ—Ç! –¶–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∏–π Secret Santa.\n\n"
                          "–ö–æ–º–∞–Ω–¥–∏:\n"
                          "/register ‚Äì –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è\n"
                          "/wish ‚Äì –¥–æ–¥–∞—Ç–∏ –±–∞–∂–∞–Ω–Ω—è\n"
                          "/info ‚Äì –ø–æ–¥–∏–≤–∏—Ç–∏—Å—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é\n"
                          "/admin ‚Äì —Å—Ç–∞—Ç–∏ –∞–¥–º—ñ–Ω–æ–º (–ø–µ—Ä—à–∏–π —Ö—Ç–æ –Ω–∞–ø–∏—à–µ)\n"
                          "/start_game ‚Äì –ø–æ—á–∞—Ç–∏ –≥—Ä—É (–∞–¥–º—ñ–Ω)\n")

@bot.message_handler(commands=['admin'])
def set_admin(message):
    global admin_id
    if admin_id is None:
        admin_id = message.chat.id
        bot.reply_to(message, "üîë –í–∏ —Ç–µ–ø–µ—Ä –∞–¥–º—ñ–Ω!")
    else:
        bot.reply_to(message, "–ê–¥–º—ñ–Ω —É–∂–µ —ñ—Å–Ω—É—î.")

@bot.message_handler(commands=['register'])
def register(message):
    username = message.from_user.username
    if not username:
        bot.reply_to(message, "–£ –≤–∞—Å –Ω–µ–º–∞—î username —É Telegram!")
        return
    if username in participants:
        bot.reply_to(message, "–í–∏ –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ!")
        return
    participants[username] = {"name": message.from_user.first_name, "wish": None}
    bot.reply_to(message, "‚úÖ –í–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ!")

@bot.message_handler(commands=['wish'])
def wish(message):
    username = message.from_user.username
    if not username or username not in participants:
        bot.reply_to(message, "–°–ø–æ—á–∞—Ç–∫—É –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è: /register")
        return
    wish_text = message.text.replace("/wish", "").strip()
    if not wish_text:
        bot.reply_to(message, "–ù–∞–ø–∏—à—ñ—Ç—å –±–∞–∂–∞–Ω–Ω—è —Ç–∞–∫: /wish —à–æ–∫–æ–ª–∞–¥ üç´")
        return
    participants[username]["wish"] = wish_text
    bot.reply_to(message, "üéÅ –ë–∞–∂–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!")

@bot.message_handler(commands=['info'])
def info(message):
    username = message.from_user.username
    if username in participants:
        wish = participants[username]["wish"]
        bot.reply_to(message, f"–í–∞—à–µ –±–∞–∂–∞–Ω–Ω—è: {wish if wish else '–Ω–µ –≤–∫–∞–∑–∞–Ω–æ'}")
    else:
        bot.reply_to(message, "–í–∏ —â–µ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ!")

@bot.message_handler(commands=['start_game'])
def start_game(message):
    global game_started
    if message.chat.id != admin_id:
        bot.reply_to(message, "–í–∏ –Ω–µ –∞–¥–º—ñ–Ω!")
        return
    if game_started:
        bot.reply_to(message, "–ì—Ä–∞ –≤–∂–µ –ø–æ—á–∞–ª–∞—Å—è!")
        return
    if len(participants) < 3:
        bot.reply_to(message, "–ú–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± 3 —É—á–∞—Å–Ω–∏–∫–∏!")
        return

    game_started = True
    users = list(participants.keys())
    receivers = users.copy()
    random.shuffle(receivers)

    # –ü–µ—Ä–µ–º—ñ—à—É—î–º–æ —Ç–∞–∫, —â–æ–± –Ω—ñ—Ö—Ç–æ –Ω–µ –æ—Ç—Ä–∏–º–∞–≤ —Å–∞–º —Å–µ–±–µ
    while any(u == r for u, r in zip(users, receivers)):
        random.shuffle(receivers)

    for giver, receiver in zip(users, receivers):
        wish = participants[receiver]["wish"]
        bot.send_message(
            chat_id=message.chat.id,
            text=f"üéÖ @{giver}, —Ç–∏ ‚Äî –°–∞–Ω—Ç–∞ –¥–ª—è @{receiver}!\n"
                 f"–ô–æ–≥–æ –±–∞–∂–∞–Ω–Ω—è: {wish or '–Ω–µ –≤–∫–∞–∑–∞–Ω–æ'}"
        )

    bot.send_message(message.chat.id, "‚ú® –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—è!")

bot.polling()